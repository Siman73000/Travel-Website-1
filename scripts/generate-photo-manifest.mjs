import fs from "node:fs/promises";
import path from "node:path";

const ROOT = process.cwd();
const PHOTOS_ROOT = path.join(ROOT, "public", "photos");
const OUT_FILE = path.join(ROOT, "src", "data", "photoManifest.ts");

// Add more formats. Note: some (HEIC/HEIF) may not render in all browsers on Windows.
const exts = new Set([".jpg", ".jpeg", ".png", ".webp", ".gif", ".avif", ".heic", ".heif"]);

function isImage(name) {
  const ext = path.extname(name).toLowerCase();
  return exts.has(ext);
}

function sortNice(a, b) {
  return a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" });
}

async function walk(dir, prefix = "") {
  /** @type {string[]} */
  const out = [];
  /** @type {string[]} */
  const skipped = [];

  let dirents = [];
  try {
    dirents = await fs.readdir(dir, { withFileTypes: true });
  } catch {
    return { out, skipped };
  }

  for (const d of dirents) {
    if (d.isDirectory()) {
      const sub = await walk(path.join(dir, d.name), path.join(prefix, d.name));
      out.push(...sub.out);
      skipped.push(...sub.skipped);
      continue;
    }
    if (!d.isFile()) continue;

    const rel = path.join(prefix, d.name);
    if (isImage(d.name)) out.push(rel.replaceAll("\\", "/"));
    else skipped.push(rel.replaceAll("\\", "/"));
  }

  return { out, skipped };
}

async function main() {
  /** @type {Record<string, string[]>} */
  const manifest = {};
  /** @type {Record<string, string[]>} */
  const nonImages = {};

  try {
    const dirents = await fs.readdir(PHOTOS_ROOT, { withFileTypes: true });
    for (const d of dirents) {
      if (!d.isDirectory()) continue;

      const slug = d.name;
      const folder = path.join(PHOTOS_ROOT, slug);

      const { out, skipped } = await walk(folder);
      manifest[slug] = out.sort(sortNice);
      if (skipped.length) nonImages[slug] = skipped.sort(sortNice);
    }
  } catch {
    // no photos folder yet; keep manifest empty
  }

  const generatedAt = new Date().toISOString();

  const lines = [
    "/**",
    " * AUTO-GENERATED FILE â€” DO NOT EDIT BY HAND.",
    " *",
    " * Generated by: npm run photos",
    ` * Generated at: ${generatedAt}`,
    " */",
    "",
    `export const photoManifest: Record<string, string[]> = ${JSON.stringify(manifest, null, 2)};`,
    "",
    "export function photosForSlug(slug: string): string[] {",
    "  return photoManifest[slug] ?? [];",
    "}",
    "",
  ];

  await fs.mkdir(path.dirname(OUT_FILE), { recursive: true });
  await fs.writeFile(OUT_FILE, lines.join("\n"), "utf8");
  console.log(`Wrote ${OUT_FILE}`);

  // Helpful warnings
  const slugs = Object.keys(nonImages);
  if (slugs.length) {
    console.log("\nNote: These files were skipped (not a supported image format):");
    for (const slug of slugs) {
      console.log(`- ${slug}: ${nonImages[slug].join(", ")}`);
    }
    console.log("\nSupported extensions: " + Array.from(exts).join(", "));
  }
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
